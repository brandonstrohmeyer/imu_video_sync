name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v1.2.3)"
        required: true
        type: string

concurrency:
  group: release-${{ inputs.tag || github.ref_name || github.event.workflow_run.head_sha }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      tag: ${{ steps.release_tag.outputs.tag }}
    env:
      RUSTUP_TOOLCHAIN: stable
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact_name: windows-x64
            platform: windows
            data_sep: ";"
          - os: ubuntu-latest
            artifact_name: linux-x64
            platform: linux
            data_sep: ":"
          - os: macos-15-intel
            artifact_name: macos-x64
            platform: macos
            arch: x64
            data_sep: ":"
          - os: macos-14
            artifact_name: macos-arm64
            platform: macos
            arch: arm64
            data_sep: ":"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.tag || github.event.workflow_run.head_sha || github.ref }}

      - name: Resolve release tag
        id: release_tag
        shell: bash
        env:
          INPUT_TAG: ${{ inputs.tag }}
          WORKFLOW_RUN_HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          python - <<'PY'
          import os
          import re
          import subprocess
          import sys

          event = os.environ.get("GITHUB_EVENT_NAME", "")
          tag = None

          if event == "workflow_dispatch":
              tag = os.environ.get("INPUT_TAG")
          elif event == "push":
              tag = os.environ.get("GITHUB_REF_NAME")
          elif event == "workflow_run":
              sha = os.environ.get("WORKFLOW_RUN_HEAD_SHA")
              if not sha:
                  sys.exit("Missing workflow_run head sha")
              tags = subprocess.check_output(["git", "tag", "--points-at", sha], text=True).splitlines()
              tags = [t for t in tags if re.match(r"^v\\d+\\.\\d+\\.\\d+$", t)]
              tag = tags[0] if tags else None

          if not tag:
              sys.exit("Unable to resolve release tag")

          tag = tag.replace("\\n", "").replace("\\r", "").strip()
          if not re.match(r"^v\\d+\\.\\d+\\.\\d+$", tag):
              sys.exit(f"Resolved tag is invalid: {tag!r}")
          print("Resolved tag:", tag)
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"tag={tag}\\n")
          PY

      - name: Write version file
        shell: bash
        run: |
          TAG="${{ steps.release_tag.outputs.tag }}"
          echo "__version__ = \"${TAG}\"" > src/imu_video_sync/_version.py

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install -r requirements-build.txt

      - name: Ensure build dir
        run: python -c "import pathlib; pathlib.Path('build').mkdir(exist_ok=True)"

      - name: Run tests
        run: python -m pytest --junitxml build/pytest-report.xml

      - name: Fail on skipped tests
        run: >
          python -c "import xml.etree.ElementTree as ET, pathlib, sys;
          p=pathlib.Path('build/pytest-report.xml');
          p.exists() or sys.exit('Pytest report missing');
          skipped=len(ET.parse(p).findall('.//skipped'));
          skipped==0 or sys.exit(f'Pytest reported {skipped} skipped test(s).');
          print('No skipped tests.')"

      - name: Build binary (Windows)
        if: matrix.platform == 'windows'
        run: >
          python -m PyInstaller --noconfirm --onefile --noconsole --exclude-module scipy --name IMUVideoSync
          --icon assets/icon/IMUVideoSync.ico
          --paths src
          --add-data assets/icon/IMUVideoSync.ico${{ matrix.data_sep }}assets/icon
          --add-data assets/icon/IMUVideoSync.png${{ matrix.data_sep }}assets/icon
          --collect-binaries telemetry_parser
          --collect-data telemetry_parser
          --collect-submodules telemetry_parser
          scripts/imu_video_sync_entry.py

      - name: Build binary (macOS/Linux)
        if: matrix.platform != 'windows'
        run: >
          python -m PyInstaller --noconfirm --onefile --noconsole --exclude-module scipy --name IMUVideoSync
          --icon assets/icon/IMUVideoSync.ico
          --paths src
          --add-data assets/icon/IMUVideoSync.ico${{ matrix.data_sep }}assets/icon
          --add-data assets/icon/IMUVideoSync.png${{ matrix.data_sep }}assets/icon
          --collect-binaries telemetry_parser
          --collect-data telemetry_parser
          --collect-submodules telemetry_parser
          scripts/imu_video_sync_entry.py

      - name: Prepare artifact (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force release | Out-Null
          Move-Item -Force dist\IMUVideoSync.exe release\IMUVideoSync-windows-x64.exe

      - name: Prepare artifact (macOS)
        if: matrix.platform == 'macos'
        run: |
          mkdir -p release
          mv dist/IMUVideoSync release/IMUVideoSync-${{ matrix.artifact_name }}

      - name: Prepare artifact (Linux)
        if: matrix.platform == 'linux'
        run: |
          mkdir -p release
          mv dist/IMUVideoSync release/IMUVideoSync-linux-x64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: IMUVideoSync-${{ matrix.artifact_name }}
          path: release/*

  macos-universal2:
    runs-on: macos-14
    needs:
      - build
    steps:
      - name: Download macOS x64 artifact
        uses: actions/download-artifact@v4
        with:
          name: IMUVideoSync-macos-x64
          path: macos-x64

      - name: Download macOS arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: IMUVideoSync-macos-arm64
          path: macos-arm64

      - name: Build universal2 binary
        run: |
          mkdir -p release
          lipo -create \
            macos-x64/IMUVideoSync-macos-x64 \
            macos-arm64/IMUVideoSync-macos-arm64 \
            -output release/IMUVideoSync-macos-universal2
          lipo -info release/IMUVideoSync-macos-universal2

      - name: Upload universal2 artifact
        uses: actions/upload-artifact@v4
        with:
          name: IMUVideoSync-macos-universal2
          path: release/*

  publish:
    runs-on: ubuntu-latest
    needs:
      - build
      - macos-universal2
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.tag }}
          name: ${{ needs.build.outputs.tag }}
          files: release-artifacts/**/*
          draft: false
          prerelease: false
